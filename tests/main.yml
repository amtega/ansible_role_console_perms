---
# Tasks for testing role

- name: Setup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      docker_presets_images_json_query: >-
        [? starts_with(name, `centos-7`)
           || starts_with(name, `fedora-29`)
           || starts_with(name, `fedora-30`) ]

    - role: amtega.docker_sandbox
      docker_sandbox_state: started
  tags:
    - sandbox

- name: Prepare docker containers for test
  hosts: docker_sandbox_containers
  tasks:
    - name: Setup extra console_perms
      set_fact:
        console_perms_extra:
          - path: /etc/security/console.perms.d/55-default.perms
            classes:
              - name: transducer
                files:
                  - /dev/transducer/*
  tags:
    - idempotence

- name: Test console_perms role
  hosts: docker_sandbox_containers

  tasks:
    - name: Test console_perms defaults
      include_role:
        name: amtega.console_perms
        public: yes
      vars:
        console_perms_load_from_hostvars: yes

    - name: Add console_perms
      include_role:
        name: amtega.console_perms
      vars:
        console_perms_load_from_hostvars: yes
        console_perms:
          - path: /etc/security/console.perms
            classes:
              - name: console
                files:
                  - tty[0-9][0-9]*
                  - vc/[0-9][0-9]*
                  - :[0-9]+\.[0-9]+
                  - :[0-9]+
              - name: xconsole
                files:
                  - :[0-9]+\.[0-9]+
                  - :[0-9]+
          - path: /etc/security/console.perms.d/51-default.perms
            classes:
              - name: floppy
                files:
                  - /dev/fd[0-1]*
                  - /dev/floppy/*
                  - /mnt/floppy*
              - name: sound
                files:
                  - /dev/dsp*
                  - /dev/audio*
                  - /dev/midi*
                  - /dev/mixer*
                  - /dev/sequencer
                  - /dev/sound/*
                  - /dev/beep
                  - /dev/snd/*
              - name: cdrom
                files:
                  - /dev/cdrom*
                  - /dev/cdroms/*
                  - /dev/cdwriter*
                  - /mnt/cdrom*
              - name: scanner
                files:
                  - /dev/scanner
                  - /dev/usb/scanner*
            permissions:
              - class: <console>
                class_perm: "0660"
                device: <floppy>
                revert_mode: "0660"
                revert_owner: root
                revert_group: floppy
              - class: <console>
                class_perm: "0660"
                device: <sound>
                revert_mode: '0640'
                revert_owner: root
              - class: <console>
                class_perm: "0660"
                device: <cdrom>
                revert_mode: "0660"
                revert_owner: root
                revert_group: disk

    - name: Check wrappers config
      shell: grep --fixed-strings "{{ item.line }}" "{{ item.file }}"
      changed_when: false
      loop:
        - file: /etc/security/console.perms
          line: >-
            <console>=tty[0-9][0-9]* vc/[0-9][0-9]* :[0-9]+\.[0-9]+ :[0-9]+
        - file: /etc/security/console.perms
          line: '<xconsole>=:[0-9]+\.[0-9]+ :[0-9]+'
        - file: /etc/security/console.perms.d/51-default.perms
          line: "<floppy>=/dev/fd[0-1]* /dev/floppy/* /mnt/floppy*"
        - file: /etc/security/console.perms.d/51-default.perms
          line: >-
            <sound>=/dev/dsp* /dev/audio* /dev/midi* /dev/mixer*
            /dev/sequencer /dev/sound/* /dev/beep /dev/snd/*
        - file: /etc/security/console.perms.d/51-default.perms
          line: "<cdrom>=/dev/cdrom* /dev/cdroms/* /dev/cdwriter* /mnt/cdrom*"
        - file: /etc/security/console.perms.d/51-default.perms
          line: "<scanner>=/dev/scanner /dev/usb/scanner*"
        - file: /etc/security/console.perms.d/51-default.perms
          line: "<console> 0660 <floppy> 0660 root.floppy"
        - file: /etc/security/console.perms.d/51-default.perms
          line: "<console> 0660 <sound> 0640 root"
        - file: /etc/security/console.perms.d/51-default.perms
          line: "<console> 0660 <cdrom> 0660 root.disk"
      register: check_wrappers_result
  tags:
    - idempotence

- name: Cleanup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: absent
  tags:
    - cleanup
    - sandbox
